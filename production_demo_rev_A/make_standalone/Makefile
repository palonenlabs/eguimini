###############################################################################
# Makefile for the project db101_demo
# This file has been modified for "stand-alone" operation with GNU make
# based on the makefile generated by AVR-Studio.
# It's just a quick hack for the Unix/Linux-users who can not run AVR-Studio
# better solution: modify WinAVR makefile template to correctly support
# sources from different directories (maybe already done in WinAVR 5/07)
#
# (Martin Thomas 10/2007)
###############################################################################

## General Flags
PROJECT = db101_demo
MCU = atmega1281
TARGET = db101_demo.elf
###mt CC = avr-gcc.exe
CC = avr-gcc

# id to use with programmer
# default: PROGRAMMER_MCU=$(MCU)
# In case the programer used, e.g avrdude, doesn't
# accept the same MCU name as avr-gcc (for example
# for ATmega8s, avr-gcc expects 'atmega8' and 
# avrdude requires 'm8')
PROGRAMMER_MCU=m1281

# programmer id--check the avrdude for complete list
# of available opts.  These should include stk500,
# avr910, avrisp, bsd, pony and more.  Set this to
# one of the valid "-c PROGRAMMER-ID" values 
# described in the avrdude info page.
# 
AVRDUDE_PROGRAMMERID=stk500v2
#AVRDUDE_PROGRAMMERID=jtagmkII

# port--serial or parallel port to which your 
# hardware programmer is attached
#

# Mac
AVRDUDE_PORT=/dev/tty.usbserial-A7005tux

# Linux
#AVRDUDE_PORT=/dev/ttyUSB0
#AVRDUDE_PORT=usb

AVRDUDE=avrdude
HEXROMTRG=$(PROJECT).hex 

## Options common to compile, link and assembly rules
COMMON = -mmcu=$(MCU)

## Compile options common for all C compilation units.
CFLAGS = $(COMMON)
CFLAGS += -gdwarf-2  -std=gnu99
CFLAGS += -DF_CPU=7372800UL -Os 
CFLAGS += -funsigned-char -funsigned-bitfields -fpack-struct
#no: -fshort-enums 
CFLAGS += -Wall -Wno-unused 
CFLAGS += -ffunction-sections -fdata-sections
CFLAGS += -MD -MP -MT $(*F).o -MF dep/$(@F).d 

## Assembly specific flags
ASMFLAGS = $(COMMON)
ASMFLAGS += $(CFLAGS)
ASMFLAGS += -x assembler-with-cpp -Wa,-gdwarf2

## Linker flags
LDFLAGS = $(COMMON)
LDFLAGS +=  -Wl,-Map=db101_demo.map,--gc-sections


## Intel Hex file production flags
HEX_FLASH_FLAGS = -R .eeprom

HEX_EEPROM_FLAGS = -j .eeprom
HEX_EEPROM_FLAGS += --set-section-flags=.eeprom="alloc,load"
HEX_EEPROM_FLAGS += --change-section-lma .eeprom=0 --no-change-warnings


## Include Directories
###mt INCLUDES = -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\Picture_lib" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\power_driver" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\rtc_driver" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\Sound" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\termfont_lib" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\terminal_lib" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\timing_lib" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\uart_driver" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\backlight_driver" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\common" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\fifo_lib" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\forms_lib" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\gfx" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\img" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\joystick_driver" -I"D:\EigenMT\develop\uProz\db101\db101\production_demo_rev_A\..\memblock_lib" 

###mt:
EXTRAINCDIRS  = ../../common ../../Picture_lib ../../power_driver ../../rtc_driver ../../Sound
EXTRAINCDIRS += ../../termfont_lib ../../terminal_lib ../../timing_lib ../../uart_driver
EXTRAINCDIRS += ../../backlight_driver ../../fifo_lib ../../forms_lib ../../gfx ../../img 
EXTRAINCDIRS += ../../joystick_driver ../../memblock_lib
INCLUDES = $(patsubst %,-I%,$(EXTRAINCDIRS))


## Libraries
LIBS = -lm 

## Objects that must be built in order to link
OBJECTS = walkabout.o configsystem.o displaydata.o flashpics.o gameoflife.o lcdcontrast.o main.o memory.o slideshow.o smokeydemo.o snake.o sounddemo.o clock.o s6b1713_driver.o lcd_lib.o popup_lib.o gfx_lib.o joystick_driver.o power_driver.o backlight_driver.o fifo_lib.o memblock_lib.o picture_lib.o widgets_lib.o forms_lib.o dialog_lib.o rtc_driver.o timing_lib.o termfont_lib.o sound_driver.o song_lib.o

## Objects explicitly added by the user
LINKONLYOBJECTS = 

## Build
all: $(TARGET) db101_demo.hex db101_demo.eep db101_demo.lss size

## Compile
walkabout.o: ../walkabout.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

configsystem.o: ../configsystem.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

displaydata.o: ../displaydata.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

flashpics.o: ../flashpics.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

gameoflife.o: ../gameoflife.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

lcdcontrast.o: ../lcdcontrast.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

main.o: ../main.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

memory.o: ../memory.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

slideshow.o: ../slideshow.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

smokeydemo.o: ../smokeydemo.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

snake.o: ../snake.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

sounddemo.o: ../sounddemo.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

#terminal.o: ../terminal.c
#	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

clock.o: ../clock.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

s6b1713_driver.o: ../../gfx/s6b1713_driver.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

lcd_lib.o: ../../gfx/lcd_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

popup_lib.o: ../../gfx/popup_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

gfx_lib.o: ../../gfx/gfx_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

joystick_driver.o: ../../joystick_driver/joystick_driver.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

power_driver.o: ../../power_driver/power_driver.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

backlight_driver.o: ../../backlight_driver/backlight_driver.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

fifo_lib.o: ../../fifo_lib/fifo_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

memblock_lib.o: ../../memblock_lib/memblock_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

picture_lib.o: ../../Picture_lib/picture_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

widgets_lib.o: ../../forms_lib/widgets_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

forms_lib.o: ../../forms_lib/forms_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

dialog_lib.o: ../../forms_lib/dialog_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

rtc_driver.o: ../../rtc_driver/rtc_driver.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

timing_lib.o: ../../timing_lib/timing_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

termfont_lib.o: ../../termfont_lib/termfont_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

sound_driver.o: ../../Sound/sound_driver.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

song_lib.o: ../../Sound/song_lib.c
	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

#terminal_lib.o: ../../terminal_lib/terminal_lib.c
#	$(CC) $(INCLUDES) $(CFLAGS) -c  $<

##Link
$(TARGET): $(OBJECTS)
	 $(CC) $(LDFLAGS) $(OBJECTS) $(LINKONLYOBJECTS) $(LIBDIRS) $(LIBS) -o $(TARGET)

%.hex: $(TARGET)
	avr-objcopy -O ihex $(HEX_FLASH_FLAGS)  $< $@

%.eep: $(TARGET)
	-avr-objcopy $(HEX_EEPROM_FLAGS) -O ihex $< $@ || exit 0

%.lss: $(TARGET)
	avr-objdump -h -S $< > $@

size: ${TARGET}
	@echo
	@avr-size -C --mcu=${MCU} ${TARGET}

## Clean target
.PHONY: clean
clean:
	-rm -rf $(OBJECTS) db101_demo.elf dep/* db101_demo.hex db101_demo.eep db101_demo.lss db101_demo.map

upload: 
	$(AVRDUDE) -e -c $(AVRDUDE_PROGRAMMERID)   \
	 -p $(PROGRAMMER_MCU) -P $(AVRDUDE_PORT)        \
	 -U flash:w:$(HEXROMTRG)
	 


## Other dependencies
-include $(shell mkdir dep 2>/dev/null) $(wildcard dep/*)

